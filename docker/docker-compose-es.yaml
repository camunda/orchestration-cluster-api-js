services:
  camunda:
    image: camunda/camunda:${CAMUNDA_DOCKER_IMAGE_VERSION:-8.8.0}
    # If you want to override via env like the framework: set CAMUNDA_DOCKER_IMAGE_VERSION externally
    container_name: camunda-engine
    environment:
      SPRING_PROFILES_ACTIVE: 'broker,consolidated-auth'
      ZEEBE_CLOCK_CONTROLLED: 'true'
      ZEEBE_LOG_APPENDER: 'Stackdriver'
      CAMUNDA_SECURITY_AUTHENTICATION_UNPROTECTEDAPI: 'true'
      CAMUNDA_SECURITY_AUTHORIZATIONS_ENABLED: 'false'
      ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_BULK_SIZE: 1
      ZEEBE_BROKER_DATA_DISKUSAGECOMMANDWATERMARK: 0.998
      ZEEBE_BROKER_DATA_DISKUSAGEREPLICATIONWATERMARK: 0.999
      LOGGING_LEVEL_ORG_MYBATIS: 'INFO'
      ENDPOINT_PROMETHEUS_ACCESS: 'unrestricted'
      PROMETHEUS_METRICS_EXPORT_ENABLED: 'true'

    ports:
      - '8080:8080' # REST API (ZEEBE_REST_ADDRESS -> http://localhost:8080)
      - '26500:26500' # gRPC Gateway
      - '9600:9600' # Monitoring / actuator / test time control
      # Uncomment if you need direct access to internal broker ports:
      # - "26501:26501" # Command API (internal)
      # - "26502:26502" # Internal API (internal)
    healthcheck:
      # Mimic readiness checks: uses monitoring port + health endpoint
      test: ['CMD', 'wget', '-qO', '-', 'http://localhost:9600/actuator/health/status']
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - zeebe:/usr/local/zeebe/data
      - './.core/application.yaml:/usr/local/camunda/config/application.yaml'
    depends_on:
      - elasticsearch
    networks:
      - camunda-net

  elasticsearch: # https://hub.docker.com/_/elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION:-8.17.5}
    container_name: elasticsearch
    ports:
      - '9200:9200'
      - '9300:9300'
    environment:
      - bootstrap.memory_lock=true
      - discovery.type=single-node
      - xpack.security.enabled=false
      # allow running with low disk space
      - cluster.routing.allocation.disk.threshold_enabled=false
      - 'ES_JAVA_OPTS=-Xms512m -Xmx512m'
    ulimits:
      memlock:
        soft: -1
        hard: -1
    restart: always
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:9200/_cat/health | grep -q green']
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - elastic:/usr/share/elasticsearch/data
    networks:
      - camunda-net

  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus-data:/prometheus
    ports:
      - '9090:9090'
    depends_on:
      - camunda
    networks:
      - camunda-net
    extra_hosts:
      - 'host.docker.internal:host-gateway'

  grafana:
    image: grafana/grafana:11.1.0
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards/:/var/lib/grafana/dashboards/
      - ./grafana/zeebe.json/:/var/lib/grafana/dashboards/zeebe.json
      - ./grafana/zeebe-overview.json/:/var/lib/grafana/dashboards/zeebe-overview.json
      - ./grafana/backpressure.json:/var/lib/grafana/dashboards/backpressure.json
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    ports:
      - '3000:3000'
    depends_on:
      - prometheus
    networks:
      - camunda-net

networks:
  camunda-net:
    name: camunda-net

volumes:
  zeebe:
  elastic:
  prometheus-data:
  grafana-data:
